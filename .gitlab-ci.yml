variables:
  GIT_SUBMODULE_STRATEGY: recursive

build_api_reference:
  tags:
    - centos
    - docker
  script:
    - pip3 install --user -r swagger_doc_requirements.txt
    - printf "Generate documentation for commit ${CI_COMMIT_SHORT_SHA}\n\n" > commit_message
    - printf "This commit contains the automatically generated documentation based on:\n https://devhub.vr.rwth-aachen.de/VR-Group/in-situ-pipeline/insite/commit/${CI_COMMIT_SHA}:\n\n${CI_COMMIT_MESSAGE}\n\n" >> commit_message
    - printf "The documentation was generated by:\n ${CI_PIPELINE_URL}\n ${CI_JOB_URL}" >> commit_message
    - git clone https://oauth2:${ACCESS_TOKEN}@devhub.vr.rwth-aachen.de/VR-Group/in-situ-pipeline/insite.wiki.git
    - cd insite.wiki
    - mkdir -p api
    - cd api
    - rm -rf *
    - python3 ../../swagger_doc.py ../../access-node/access_node/swagger/swagger.yaml 'api/'
    - git add -u
    - git add .
    - git status
    - git diff-index --quiet HEAD || git commit -F ../../commit_message --author="GitlabCI <${GITLAB_USER_EMAIL}>"
    - git push

api_test:
  tags:
    - centos
    - docker
  artifacts:
    paths:
    - tests/docker-compose.log
    expire_in: 1 week
    when: always
  script:
    - pip3 install --user -r requirements.txt
    - pip3 install --user -r access-node/requirements.txt
    - pip3 install --user -r info-node/requirements.txt
    - pytest
