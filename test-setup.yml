variables:
    GIT_STRATEGY: none
    INFO_NODE_COMMIT: ""
    ACCESS_NODE_COMMIT: ""
    INSITE_NEST_MODULE_COMMIT: ""
  
.api_test:
    tags:
        - centos
        - docker
    artifacts:
        paths:
        - insite/tests/docker-compose.log
        expire_in: 1 week
        when: always
    script:
        - rm -rf insite
        - git clone --branch feature/add-test-pipeline --single-branch --recurse-submodules https://devhub.vr.rwth-aachen.de/VR-Group/in-situ-pipeline/insite.git
        - cd insite
        - >
            if [ ! -z "$INFO_NODE_COMMIT" ]; then
                cd info-node && git checkout $INFO_NODE_COMMIT && cd ..
            fi
        - >
            if [ ! -z "$ACCESS_NODE_COMMIT" ]; then
                cd access-node && git checkout $ACCESS_NODE_COMMIT && cd ..
            fi
        - >
            if [ ! -z "$INSITE_NEST_MODULE_COMMIT" ]; then
                cd insite-nest-module && git checkout $INSITE_NEST_MODULE_COMMIT && cd ..
            fi
        - pip3 install --user -r test-requirements.txt
        - pip3 install --user -r access-node/requirements.txt
        - pip3 install --user -r access-node/test-requirements.txt
        - pip3 install --user -r info-node/requirements.txt
        - pip3 install --user -r info-node/test-requirements.txt
        - pytest --ignore=access-node/access_node/test --ignore=info-node/info_node/test --count=30 --repeat-scope=session -x